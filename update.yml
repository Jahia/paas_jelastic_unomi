---
type: update
version: 1.5.2
name: Unomi - Update events
logo: /images/jahia-logo-70x70.png
id: jahia-unomi
description:
  short: Unomi - Update events

globals:
  datadog_key: ${settings.ddogApikey}
  shortdomain: ${settings.shortdomain}
  envname: ${env.envName}
  unomi_version: ${settings.productVersion}
  package_type: dev
ssl: true
skipNodeEmails: true

mixins:
  - jcustomer/jcustomer_actions.yml
  - elasticsearch/elasticsearch_actions.yml

onUninstall:
  cmd [${targetNodes.nodeGroup}]:
    - sed -i -e 's/.*NOPASSWD.*//g' /etc/sudoers.d/sudo
  user: root

onBeforeScaleIn[cp]:
  - saveUnomiRootPassword

onAfterScaleIn[cp]:
  - getUnomiRootPassword
  - setSomeGlobals
  - updateHazelcast
  - forEach(event.response.nodes):
      - setReplica

onBeforeServiceScaleOut[cp]:
  - saveUnomiRootPassword

onAfterServiceScaleOut[cp]:
  - getUnomiRootPassword
  - setSomeGlobals
  - updateHazelcast
  - forEach(event.response.nodes):
      - setReplica
  - setupDatadogAgentUnomi: cp

onBeforeRedeployContainer[cp]:
  - saveUnomiRootPassword

onAfterRedeployContainer[cp]:
  - getUnomiRootPassword
  - setSomeGlobals
  - setReplica
  - setupUnomi
  - setupDatadogAgentUnomi: cp

onAfterRedeployContainer[es]:
  - if ('${event.params.nodeGroup.print()}' != ''):
      - setupES: ${event.params.nodeGroup}
      - setupDatadogAgentEs: ${event.params.nodeGroup}
  - elif ('${event.params.nodeId.print()}' != ''):
      - setupES: ${event.params.nodeId}
      - setupDatadogAgentEs: ${event.params.nodeId}

onAfterServiceScaleOut[es]:
  - setSomeGlobals
  - setupES: es
  - setReplica
  - updateReplica
  - setupDatadogAgentEs: es

onAfterScaleIn[es]:
  - setSomeGlobals
  - setupES: es
  - setReplica
  - updateReplica

onBeforeDelete:
  deleteEnvLink
