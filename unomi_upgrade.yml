---
type: update
version: 0.1
name: Unomi - Upgrade
id: unomi-upgrade
description:
  short: Unomi - Upgrade

onInstall:
  # By default we assume it is a (rolling) redeploy only
  - setGlobals:
      currentDockerTag: ${nodes.cp.first.version}
      targetDockerTag: ${nodes.cp.first.version}
  # If a version/docker tag was passed as parameter
  - if ('${settings.targetVersion.print()}' != ''):
      - setGlobals:
          targetDockerTag: ${settings.targetVersion}

  - cmd[cp]: |-
      service karaf stop
    user: root

  - env.control.AddContainerEnvVars[*]:
    vars: {"UNOMI_VERSION": "${globals.targetDockerTag}", "PACKAGE_TYPE": "${settings.packageType}"}

  - api: environment.control.RedeployContainersByGroup
    nodeGroup: cp
    tag: ${globals.targetDockerTag}
    useExistingVolumes: true
    skipReinstall: false
    envName: ${env.envName}

  - script: |
      var oldVersion = "${globals.currentDockerTag}";
      var newVersion = "${globals.targetDockerTag}";
      if (oldVersion > "1.4.0" || newVersion < "1.4.0") {
        return {"result": 0, "out": "No need to upgrade module on jahia"};
      }

      jahia_linked = [];
      envs = jelastic.environment.control.getenvs("appstore", session)["infos"];

      for (i in envs) {
        nodeGroups = envs[i]["nodeGroups"];
        for (j in nodeGroups) {
          if (nodeGroups[j]["envLink"] == "${env.envName}") {
            jahia_linked.push(envs[i]["env"]["envName"]);
            break;
          }
        }
      }

      if (jahia_linked.length == 0) {
        return {"result": 0, "out": "No jahia linked"};
      }

      res = ""
      jahia_linked.forEach(
        function(jahiaEnvname) {
          data = {
            "targetAppid": jahiaEnvname,
            "settings": {"unomienv": "${env.envName}"},
            "manifest": "${baseUrl}/unomi_update_dx.yml"
          };
          res += res + jelastic.dev.scripting.eval("appstore", session, "InstallApp", data);
        }
      );
      return {"result": 0, "out": "Jahia environments updated " + res};


settings:
  fields:
    - name: targetVersion
      type: string
      caption: DX Target Version
      vtype: text
      required: false
      tooltip: Optional. If you don't specify a version, the current version of the target environment will be selected.
    - name: packageType
      type: string
      caption: Package Type
      default: dev
      vtype: text
      required: true
      tooltip: Required. Should be "dev" or "prod".
