---
type: install
version: 1.5.2
name: Unomi - Install
logo: /images/jahia-logo-70x70.png
id: jahia-elasticsearch
description:
  short: Elasticsearch - Install
  text: POC PAAS-1391

globals:
  es_version: 7
  package_type: dev
ssl: true
skipNodeEmails: true

mixins:
  - common/common_actions.yml
  - elasticsearch/elasticsearch_actions.yml

onBeforeInstall: |
  var resp = {
    result: 0,
    nodes: []
  }

  node_es = {
    nodeType: "jahiastic-elasticsearch",
    tag: ${globals.es_version},
    displayName: "Elasticsearch v" + ${globals.es_version},
    count: ${settings.ESMode},
    cloudlets: 96,
    nodeGroup: 'es',
    isSLBAccessEnabled: false,
    startServiceOnCreation: false,
    env: {
      PACKAGE_TYPE: '${globals.package_type}',
      jahia_cfg_operatingMode: '${settings.mode}',
      _PROVIDE: 'elasticsearch',
      ES_VERSION: ${globals.es_version},
      envmode: '${settings.mode}'
    },
    "volumes": [
      "/var/lib/elasticsearch"
    ]
  }

  resp.nodes.push(node_es)
  return resp

nodes: definedInOnBeforeInstall

# --Events --
onInstall:
  - environment.control.ApplyNodeGroupData [es]:
      data:
        productName: elasticsearch
        productVersion: ${globals.es_version}
        packageType: ${globals.package_type}
  - getLogEventScript: es
  - env.control.AddContainerEnvVars [*]:
    vars: {"envName": "${env.envName}", "DATADOGAPIKEY": "${settings.ddogApikey}"}
  - updateHosts
  - setupES: es
  - setReplica
  - updateReplica
  - setupDatadogAgentEs: es
  - getReleaseMajorVersion
  - setEnvVersion: ${globals.envVersion}

onBeforeRedeployContainer[es]:
  - if (nodes.es.length > 1):
      - log: "This is an ES cluster, disable shards allocation and flush before stopping node"
      - if ('${event.params.nodeGroup.print()}' != ''):
          - setShardAllocation:
              target: ${nodes.es.master.id}
              allocation: "primaries"
          - forEach(nodes.es):
              - forceESFlush:
                  target: ${@i.id}
      - elif ('${event.params.nodeId.print()}' != ''):
          - setShardAllocation:
              target: ${event.params.nodeId}
              allocation: "primaries"
          - forceESFlush:
              target: ${event.params.nodeId}

onAfterRedeployContainer[es]:
  - if ('${event.params.nodeGroup.print()}' != ''):
      - setupES: ${event.params.nodeGroup}
      - setupDatadogAgentEs: ${event.params.nodeGroup}
      - if (nodes.es.length > 1):
          - log: "This is an ES cluster, enable shards allocation"
          - setShardAllocation:
              target: ${nodes.es.master.id}
              allocation: "null"
  - elif ('${event.params.nodeId.print()}' != ''):
      - setupES: ${event.params.nodeId}
      - setupDatadogAgentEs: ${event.params.nodeId}
      - if (nodes.es.length > 1):
          - log: "This is an ES cluster, enable shards allocation"
          - setShardAllocation:
              target: ${event.params.nodeId}
              allocation: "null"

onAfterServiceScaleOut[es]:
  - forEach(event.response.nodes):
      cmd[${@i.id}]: |-
        service elasticsearch stop
        rm -rf /var/lib/elasticsearch/nodes
  - setupES: es
  - setReplica
  - updateReplica
  - setupDatadogAgentEs: es

onAfterScaleIn[es]:
  - setupES: es
  - setReplica
  - updateReplica

onBeforeDelete:
  - logEvent:
      target: ${nodes.cp.first.id}
      title: "Deleting environment $envName"
      text: "$envName is going to be deleted"
  - deleteEnvLink

onBeforeStop:
  - logEvent:
      target: ${nodes.cp.first.id}
      title: "Stopping environment $envName"
      text: "$envName is going to stop"
  - if (nodes.es.length > 1):
      - log: "This is an ES cluster, disable shards allocation and flush before stopping the environment"
      - setShardAllocation:
          target: ${nodes.es.master.id}
          allocation: "primaries"
      - forEach(nodes.es):
          - forceESFlush:
              target: ${@i.id}

onAfterStart:
  - logEvent:
      target: ${nodes.cp.first.id}
      title: "$envName environment started"
      text: "$envName is started"
  - if (nodes.es.length > 1):
      - log: "This is an ES cluster, enable shards allocation"
      - setShardAllocation:
          target: ${nodes.es.master.id}
          allocation: "null"

onBeforeMigrate:
  logEvent:
    target: ${nodes.cp.first.id}
    title: "Migration triggered for $envName environment"
    text: "$envName going to be migrate"

onAfterMigrate:
  logEvent:
    target: ${nodes.cp.first.id}
    title: "Environment $envName migrated"
    text: "$envName has been migrated"

onBeforeRestartNode[es]:
  - if (nodes.es.length > 1):
      - log: "This is an ES cluster, disable shards allocation and flush before stopping node"
      - setShardAllocation:
          target: ${event.params.nodeId}
          allocation: "primaries"
      - forceESFlush:
          target: ${event.params.nodeId}

onBeforeRestartNode:
  - logEvent:
      target: ${event.params.nodeid}
      title: "Restarting node ${event.params.nodeid}"
      text: "${event.params.nodeid} node is going to be restarted"

onAfterRestartNode[es]:
  - if (nodes.es.length > 1):
      - log: "This is an ES cluster, enable shards allocation"
      - setShardAllocation:
          target: ${event.params.nodeId}
          allocation: "null"

onAfterRestartNode[cp]:
  checkJcustomerHealthWhenStarting: ${event.params.nodeId}

onAfterRestartNode:
  - logEvent:
      target: ${event.params.nodeid}
      title: "Node ${event.params.nodeid} restarted"
      text: "Node ${event.params.nodeid} has restarted"

onBeforeRedeployContainer:
  - if ('${event.params.nodeGroup.print()}' != ''):
      logEvent:
        target: ${event.params.nodeGroup}
        title: "Redeploying ${event.params.nodeGroup} nodes to ${event.params.tag} version"
        text: "${event.params.nodeGroup} nodes are going to be redeploy to ${event.params.tag} version"
  - elif ('${event.params.nodeid.print()}' != ''):
      logEvent:
        target: ${nodes.es.first.id}
        title: "Redeploying node ${event.params.nodeid} to ${event.params.tag} version"
        text: "Node ${event.params.nodeid} is going to be redeploy to ${event.params.tag} version"

onAfterRedeployContainer:
  - if ('${event.params.nodeGroup.print()}' != ''):
      - getLogEventScript: ${event.params.nodeGroup}
      - logEvent:
          target: ${event.params.nodeGroup}
          title: "${event.params.nodeGroup} nodes have been redeployed to ${event.params.tag} version"
          text: "${event.params.nodeGroup} nodes have been redeployed to ${event.params.tag} version"
  - elif ('${event.params.nodeid.print()}' != ''):
      - getLogEventScript: ${event.params.nodeid}
      - logEvent:
          target: ${event.params.nodeid}
          title: "Node ${event.params.nodeid} redeployed to ${event.params.tag} version"
          text: "Node ${event.params.nodeid} has been redeploy to ${event.params.tag} version"

onBeforeScaleIn:
  forEach(event.response.nodes):
    logEvent:
      target: ${@i.id}
      title: "Scaling in ${event.params.nodeGroup} node group"
      text: "Node ${@i.id} is going to be removed"

onAfterServiceScaleOut:
  forEach(event.response.nodes):
    logEvent:
      target: ${@i.id}
      title: "Scaled out ${event.params.nodeGroup} node group"
      text: "Node ${@i.id} has been added"

settings:
  fields:
    - name: ESMode
      type: list
      caption: Elasticsearch mode
      values:
        "1": single
        "3": 3 nodes cluster
        "5": 5 nodes cluster
      default: 1
    - name: mode
      type: radiolist
      caption: Operating Mode
      values:
        production: production
        development: development
      default: production
    - name: ddogApikey
      type: string
      caption: Datadog API KEY
      required: true
      vtype: text
