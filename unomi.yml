---
type: install
version: 1.5.2
name: Unomi - Install
logo: /images/jahia-logo-70x70.png
id: jahia-unomi
description:
  short: Unomi - Install
  text: This is the Jahia Cloud package for Unomi.
    Apache Unomi is a Java Open Source customer data platform, a Java server
    designed to manage customers, leads and visitors data and help personalize
    customers experiences while also offering features to respect visitor
    privacy rules (such as GDPR).

globals:
  datadog_key: ${settings.ddogApikey}
  shortdomain: ${settings.shortdomain}
  envname: ${env.envName}
  unomi_version: ${settings.productVersion}
  package_type: dev
  unomi_root_password: ${fn.password(20)}
ssl: true
skipNodeEmails: true

mixins:
  - common/common_actions.yml
  - jcustomer/jcustomer_actions.yml
  - elasticsearch/elasticsearch_actions.yml

onBeforeInstall: |
  var unomiVersion = '${settings.productVersion}'

  var resp = {
    result: 0,
    nodes: []
  }

  // Elasticsearch port and version changes from jCustomer 1.5
  if (unomiVersion >= "1.5") {
    esPort = "9200";
    esVersion = 7;
  } else {
    esPort = "9300";
    esVersion = 5;
  }

  node_es = {
    nodeType: "jahiastic-elasticsearch",
    tag: esVersion,
    displayName: "Elasticsearch v" + esVersion,
    count: ${settings.ESMode},
    cloudlets: 40,
    nodeGroup: 'es',
    isSLBAccessEnabled: false,
    env: {
      PACKAGE_TYPE: '${globals.package_type}',
      UNOMI_VERSION: unomiVersion,
      jahia_cfg_operatingMode: '${settings.mode}',
      envName: '${env.envName}',
      _ROLE: 'unomi',
      _PROVIDE: 'elasticsearch',
      ES_VERSION: esVersion,
      envmode: '${settings.mode}'
    },
    "volumes": [
      "/var/lib/elasticsearch"
    ]
  }

  node_unomi = {
    nodeType: "jcustomer",
    tag: unomiVersion,
    displayName: "Unomi v" + unomiVersion,
    count: ${settings.UnomiMode},
    cloudlets: 32,
    nodeGroup: 'cp',
    links: 'es:es',
    startServiceOnCreation: false,
    env: {
      PACKAGE_TYPE: '${globals.package_type}',
      UNOMI_VERSION: unomiVersion,
      jahia_cfg_operatingMode: '${settings.mode}',
      envName: '${env.envName}',
      UNOMI_HTTP_PORT: '80',
      UNOMI_ELASTICSEARCH_ADDRESSES: 'es:' + esPort,
      UNOMI_ELASTICSEARCH_CLUSTERNAME: 'jahia-dx',
      _ROLE: 'unomi',
      _PROVIDE: 'unomi',
      ES_VERSION: esVersion,
      envmode: '${settings.mode}'
    }
  }

  resp.nodes.push(node_unomi)
  resp.nodes.push(node_es)
  return resp

nodes: definedInOnBeforeInstall

# --Events --

onUninstall:
  cmd [${targetNodes.nodeGroup}]:
    - sed -i -e 's/.*NOPASSWD.*//g' /etc/sudoers.d/sudo
  user: root

onInstall:
  - if (settings.rootPassword):
      setGlobals:
        unomi_root_password: ${settings.rootPassword}
  - environment.control.ApplyNodeGroupData [cp, es]:
      data:
        productName: unomi
        productVersion: ${globals.unomi_version}
        packageType: ${globals.package_type}
  - setJournaldLimit
  - setSomeGlobals
  - env.control.AddContainerEnvVars [*]:
    vars: {"envName": "${env.envName}", "DATADOGAPIKEY": "${settings.ddogApikey}"}
  - setupES: es
  - setReplica
  - updateReplica
  - setupUnomi
  - setupDatadogAgentUnomi: cp
  - setupDatadogAgentEs: es
  - getReleaseMajorVersion
  - setEnvVersion: ${globals.envVersion}

onBeforeScaleIn[cp]:
  - saveUnomiRootPassword

onAfterScaleIn[cp]:
  - getUnomiRootPassword
  - setSomeGlobals
  - updateHazelcast
  - forEach(event.response.nodes):
      - setReplica

onBeforeServiceScaleOut[cp]:
  - saveUnomiRootPassword

onAfterServiceScaleOut[cp]:
  - getUnomiRootPassword
  - setSomeGlobals
  - updateHazelcast
  - forEach(event.response.nodes):
      - setReplica
  - setupDatadogAgentUnomi: cp

onBeforeRedeployContainer[cp]:
  - saveUnomiRootPassword

onAfterRedeployContainer[cp]:
  - getUnomiRootPassword
  - setSomeGlobals
  - setReplica
  - setupUnomi
  - setupDatadogAgentUnomi: cp

onAfterRedeployContainer[es]:
  - if ('${event.params.nodeGroup.print()}' != ''):
      - setupES: ${event.params.nodeGroup}
      - setupDatadogAgentEs: ${event.params.nodeGroup}
  - elif ('${event.params.nodeId.print()}' != ''):
      - setupES: ${event.params.nodeId}
      - setupDatadogAgentEs: ${event.params.nodeId}

onAfterServiceScaleOut[es]:
  - setSomeGlobals
  - setupES: es
  - setReplica
  - updateReplica
  - setupDatadogAgentEs: es

onAfterScaleIn[es]:
  - setSomeGlobals
  - setupES: es
  - setReplica
  - updateReplica

onBeforeDelete:
  deleteEnvLink

# -- Actions --
actions:
  setSomeGlobals:
    setGlobals:
      PRONAME: "UNOMI"

settings:
  fields:
    - name: productVersion
      type: string
      caption: jCustomer Version
      required: true
    - name: UnomiMode
      type: list
      caption: jCustomer mode
      values:
        "1": single
        "2": 2 nodes cluster
        "3": 3 nodes cluster
        "4": 4 nodes cluster
        "5": 5 nodes cluster
        "6": 6 nodes cluster
        "7": 7 nodes cluster
      default: 1
    - name: ESMode
      type: list
      caption: Elasticsearch mode
      values:
        "1": single
        "3": 3 nodes cluster
        "5": 5 nodes cluster
      default: 1
    - name: mode
      type: radiolist
      caption: Operating Mode
      values:
        production: production
        development: development
      default: production
    - name: ddogApikey
      type: string
      caption: Datadog API KEY
      required: true
      vtype: text
    - name: rootPassword
      type: string
      caption: Unomi root password
