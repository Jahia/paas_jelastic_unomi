---
type: update
version: 0.1
name: Unomi - set root password
id: unomi-set-root-password
description:
  short: Unomi - set new root password

globals:
  new_password: ${settings.rootpwd}
  env_file: "/opt/jcustomer/jcustomer/bin/setenv"
  old_env_file: "/opt/unomi/unomi-$STACK_VERSION/bin/setenv"
  datatog_file: "/etc/datadog-agent/conf.d/jmx.d/conf.yaml"
  script_path: "/usr/local/bin/reset-unomi-root-password.py"

onInstall:
  - script: |-
      var newUrl = "${baseUrl}".split('/')
      newUrl.pop();
      newUrl.pop();
      return {result: 0, "universal_url": newUrl.join('/')};
  - setGlobals:
      universal_url: ${response.universal_url}
  - cmd [cp]: |-
      yum install -y python3
      wget -O ${globals.script_path} ${globals.universal_url}/scripts/reset-unomi-root-password.py
      chmod u+x ${globals.script_path}
      if [ -f "${globals.env_file}" ]; then envfile="${globals.env_file}"; else envfile="${globals.old_env_file}"; fi
      ${globals.script_path} "${globals.new_password}" "${envfile}" "${globals.datatog_file}"

settings:
  fields:
    - name: rootpwd
      type: string
      caption: New Unomi root password
      inputType: password
      required: true
