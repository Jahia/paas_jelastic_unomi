---

actions:
  getReleaseMajorVersion:
    - script: |-
        var url = "${baseUrl}"
        expr_branch = /.+\/(.+)\/$/
        branch = url.match(expr_branch)[1]
        release_version = branch.split('.')[0].match(/[0-9]+/)

        return {"result": 0, "release_version": release_version}
    - setGlobals:
        envVersion: ${response.release_version}

  checkEnvVersion:
    - script: |-
        const currentVersion = jelastic.env.control.GetNodeGroups("${env.envName}", session).object.filter(function (object) {
            return object.name == "cp";
        }).pop().envVersion;
        if (${this} <= currentVersion) {
            return {'result': 1, 'error': 'Environment is already up-to-date'}
        } else {
            return {'result': 0, 'out': 'Environment needs to be updated'}
        }

  # If the parameter is not an integer, we don't set the env version
  setEnvVersion:
    - if (/^[0-9]+$/.test(${this})):
        - script: |
            return api.env.control.ApplyNodeGroupData("${env.envName}", session, "cp", { envVersion: ${this} });
    - else:
        - log: "The parameter '${this}' is not an integer, nothing to do"
